<!doctype html>
<html lang="ja">
	<head>
		<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/choir.css">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon.ico">
    <!--link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon-16x16.png">
    <link rel="manifest" href="/img/site.webmanifest">
    <link rel="mask-icon" href="/img/safari-pinned-tab.svg" color="#5bbad5">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff"!-->
  	<script src="/js/get_mp3.js"></script>
    <script src="/js/get_information.js"></script>
    <script src="/js/svgPiano.js"></script>
    <script src="/js/howler.core.js"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
		<script type='text/javascript'>
      const mp3Files = {
        temp98_soprano       : '/christmas/The First Noel/01 The First Noel(soprano).mp3',
        temp98_alto          : '/christmas/The First Noel/02 The First Noel(alto).mp3',
        temp98_tenor         : '/christmas/The First Noel/03 The First Noel(tenor).mp3',
        temp98_bass          : '/christmas/The First Noel/04 The First Noel(bass).mp3',
        temp98_full          : '/christmas/The First Noel/The First Noel.mp3',
        temp98_vcl_soprano   : '/christmas/The First Noel/01 The First Noel(vcl_soprano_tmp98).mp3',
        temp98_vcl_alto      : '/christmas/The First Noel/02 The First Noel(vcl_alto_tmp98).mp3',
        temp98_vcl_tenor     : '/christmas/The First Noel/03 The First Noel(vcl_tenor_tmp98).mp3',
        temp98_vcl_all_tenor : '/christmas/The First Noel/03 The First Noel(vcl_all_tenor_tmp98).mp3',
        temp98_vcl_bass      : '/christmas/The First Noel/04 The First Noel(vcl_bass_tmp98).mp3',
        temp98_vcl_full      : '/christmas/The First Noel/05 The First Noel(vcl_full_tmp98).mp3',
        temp120_vcl_soprano   : '/christmas/The First Noel/01 The First Noel(vcl_soprano).mp3',
        temp120_vcl_alto      : '/christmas/The First Noel/02 The First Noel(vcl_alto).mp3',
        temp120_vcl_tenor     : '/christmas/The First Noel/03 The First Noel(vcl_tenor).mp3',
        temp120_vcl_all_tenor : '/christmas/The First Noel/03 The First Noel(vcl_all_tenor).mp3',
        temp120_vcl_bass      : '/christmas/The First Noel/04 The First Noel(vcl_bass).mp3',
        temp120_vcl_full      : '/christmas/The First Noel/05 The First Noel(vcl_full).mp3' 
      }
      const midiFiles = {
        temp98_soprano    : ['/christmas/The First Noel/The First Noel (tempo98).mid',0],
        temp98_alto       : ['/christmas/The First Noel/The First Noel (tempo98).mid',1],
        temp98_tenor      : ['/christmas/The First Noel/The First Noel (tempo98).mid',2],
        temp98_all_tenor  : ['/christmas/The First Noel/The First Noel (tempo98).mid',2],
        temp98_bass       : ['/christmas/The First Noel/The First Noel (tempo98).mid',3],
        temp98_full       : ['/christmas/The First Noel/The First Noel (tempo98).mid',[0,1,2,3]],
        temp120_soprano    : ['/christmas/The First Noel/The First Noel (tempo120).mid',0],
        temp120_alto       : ['/christmas/The First Noel/The First Noel (tempo120).mid',1],
        temp120_tenor      : ['/christmas/The First Noel/The First Noel (tempo120).mid',2],
        temp120_all_tenor  : ['/christmas/The First Noel/The First Noel (tempo120).mid',2],
        temp120_bass       : ['/christmas/The First Noel/The First Noel (tempo120).mid',3],
        temp120_full       : ['/christmas/The First Noel/The First Noel (tempo120).mid',[0,1,2,3]]
      }
      const ranges = (name,segment) => {
        const conversionTable = {
          temp98_soprano   : 'temp98_main_stbf', 
          temp98_alto      : 'temp98_main_a', 
          temp98_tenor     : 'temp98_main_stbf', 
          temp98_all_tenor : 'temp98_main_stbf', 
          temp98_bass      : 'temp98_main_stbf', 
          temp98_full      : 'temp98_main_stbf', 
          temp120_vcl_soprano   : 'temp120_vcl_saf',
          temp120_vcl_alto      : 'temp120_vcl_saf',
          temp120_vcl_tenor     : 'temp120_vcl_tb',
          temp120_vcl_all_tenor : 'temp120_vcl_tb',
          temp120_vcl_bass      : 'temp120_vcl_tb',
          temp120_vcl_full      : 'temp120_vcl_saf',
          temp98_vcl_soprano   : 'temp98_vcl_satbf',
          temp98_vcl_alto      : 'temp98_vcl_satbf',
          temp98_vcl_tenor     : 'temp98_vcl_satbf',
          temp98_vcl_all_tenor : 'temp98_vcl_satbf',
          temp98_vcl_bass      : 'temp98_vcl_satbf',
          temp98_vcl_full      : 'temp98_vcl_satbf'
        }
        const ranges = {
          temp98_main_stbf: //soprano, tenor, bass, full
            {
              'A': '0,35.8',
              'B': '36,50.2',
              'C': '50.8,80',
              'D': '80.5,113.5'
            },
          temp98_main_a:
            {
              'A': '0,36.3',
              'B': '36.5,50.1',
              'C': '50.1,80',
              'D': '80.1,113.5'
            },
          temp120_vcl_saf: //soprano, alto, full
            {
              'A': '0,29.2',
              'B': '29.2,40.9',
              'C': '41,64.5',
              'D': '64.5,90.8'
            },
          temp120_vcl_tb : //tenor, all_tenor, bass
            {
              'A': '0,29.2',
              'B': '28.9,40.6',
              'C': '41,64.5',
              'D': '64.9,90.8'
            },
          temp98_vcl_satbf :
            {
              'A': '0,35.1',
              'B': '35.2,49.6',
              'C': '50.4,79.4',
              'D': '79,111.8'
            },
        }
        const fileName = conversionTable[name];
        return ranges[fileName][segment];
      }
		</script>
    <style>
      div.audio-container {
        height: 30px;
        width: 400px;
        display: flex;
        flex-direction: row;
        align-items: center;
        margin-bottom: 10px;
        gap: 5px
      }
      span.timeDisplay {
        width: auto;
        font-size: 12px;
        text-wrap: nowrap;
      }
      div.segment-btn-container {
        width: auto;
        display: block;
        margin-bottom: 10px;
      }
      div.segment-btn-container button {
        width: auto;
        height: 1.6em;
        margin-right: 5px;
      }
      li {height: auto;}
      li div {
        width: "";
        display: block;
      }
      div.vcl {
        font-weight: 400;
        margin-top: 30px;
      }
    </style>
    <title>'The First Noel'　　パート別練習用音源</title>
	</head>
	<body>
<div class="body">
<h1>パート別練習用音源</h1>
<div class='nen'>
  <h4>The First Noel</h4>
  <ul style="list-style: none;">
    <li>
      <div class="part">ソプラノ</div>
      <div class="audio-container" name="temp98_soprano"></div>
      <div class="segment-btn-container" name="temp98_soprano">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
      <div class="vcl">
        AI Vocal
        &nbsp;&nbsp;&#9833;<span id="vcl_soprano_tempo">=120</span>
        &nbsp;&nbsp;<button onclick="change_tempo('vcl_soprano')">テンポ切替</button>
      </div> 
      <div class="audio-container" name="vcl_soprano"></div>
      <div class="segment-btn-container" name="vcl_soprano">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
    </li>
    <li>
      <div class="part">アルト</div>
      <div class="audio-container" name="temp98_alto"></div>
      <div class="segment-btn-container" name="temp98_alto">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
      <div class="vcl">
        AI Vocal
        &nbsp;&nbsp;&#9833;<span id="vcl_alto_tempo">=120</span>
        &nbsp;&nbsp;<button onclick="change_tempo('vcl_alto')">テンポ切替</button>
      </div>
      <div class="audio-container" name="vcl_alto"></div>
      <div class="segment-btn-container" name="vcl_alto">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
    </li>
    <li>
      <div class="part">テノール</div>
      <div class="audio-container" name="temp98_tenor"></div>
      <div class="segment-btn-container" name="temp98_tenor">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
      <div class="vcl">
        AI Vocal
        &nbsp;&nbsp;&#9833;<span id="vcl_all_tenor_tempo">=120</span>
        &nbsp;&nbsp;<button onclick="change_tempo('vcl_all_tenor')">テンポ切替</button><span style="font-size:70%;font-weight:normal;">  ※8ページ上段を主旋律からテノールの旋律に変更しました。</span>
      </div>
      <div class="audio-container" name="vcl_all_tenor"></div>
      <div class="segment-btn-container" name="vcl_all_tenor">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
    </li>
    <li>
      <div class="part">バス</div>
      <div class="audio-container" name="temp98_bass"></div>
      <div class="segment-btn-container" name="temp98_bass">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
      <div class="vcl">
        AI Vocal
        &nbsp;&nbsp;&#9833;<span id="vcl_bass_tempo">=120</span>
        &nbsp;&nbsp;<button onclick="change_tempo('vcl_bass')">テンポ切替</button>
      </div>
      <div class="audio-container" name="vcl_bass"></div>
      <div class="segment-btn-container" name="vcl_bass">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
    </li>
    <li>
      <div class="part">コーラス</div>
      <div class="audio-container" name="temp98_full"></div>
      <div class="segment-btn-container" name="temp98_full">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
      <div class="vcl">
        AI Vocal
        &nbsp;&nbsp;&#9833;<span id="vcl_full_tempo">=120</span>
        &nbsp;&nbsp;<button onclick="change_tempo('vcl_full')">テンポ切替</button>
      </div>
      <div class="audio-container" name="vcl_full"></div>
      <div class="segment-btn-container" name="vcl_full">
        <button class="playBtn" name='A'>A(･･･あめよりひびきぬ)</button>
        <button class="playBtn" name='B'>B(よろこび･･･生まれぬ)</button>
        <button class="playBtn" name='C'>C(あおげば･･･輝き渡れリ)</button>
        <button class="playBtn" name='D'>D(よろこび讃えよ･･･)</button>
      </div>
    </li>
  </ul>
  </div>

  <div id="piano-container"></div>

  <div class="nen">
  <ul style="list-style: none;">
    <li>
      <div class="part"><a href='#' onclick="plus_password('./The First Noel.pdf')">楽　譜</a></div>
    </li>
    <li><div class="part">連　絡</div>
      <div class="textarea">
        <textarea readonly cols="32" rows="10"><!--連絡事項--></textarea>
        <a href="https://i.gyazo.com/7de42dcf1b8a48c96e4e2075bac783ea.png" target="_blank"><image src="https://i.gyazo.com/7de42dcf1b8a48c96e4e2075bac783ea.png" width="300px"></image></a>
      </div>  
    </li>
  </ul>
</div>
<div class='link'>
  <a href='../Celebrate-the-King/Celebrate-the-King.html'>⇒Celebrate the Kingの音源へ</a>
  <br>
  <a href='/mcc/index.html'>⇒ MCCワーシップクワイアーの持ち歌のページに戻る.</a></div>
</div>
<!--audio style="visibility:hidden;" src='/christmas/The First Noel/01 The First Noel (vcl_soprano_tmp98).mp3' controls preload="none"></-audio>
<audio style="visibility:hidden;" src='/christmas/The First Noel/02 The First Noel (vcl_alto_tmp98).mp3' controls preload="none"></audio>
<audio style="visibility:hidden;" src='/christmas/The First Noel/03 The First Noel (vcl_tenor_tmp98).mp3' controls preload="none"></audio>
<audio style="visibility:hidden;" src='/christmas/The First Noel/04 The First Noel (vcl_bass_tmp98).mp3' controls preload="none"></audio>
<audio!-- style="visibility:hidden;" src='/christmas/The First Noel/05 The First Noel (vcl_full_tmp98).mp3' controls preload="none"></audio!-->
	
<script>
  // ピアノ鍵盤のSVGを作成
  const svgPiano = new SvgPiano(
    'piano-container',
    {
        min_key_number: 39,
        number_of_white_keys: 23,
        white_key_width: 30,
        white_key_height: 120,
        black_key_width: 24,
        black_key_height: 70,
        volume: 0.5,
        key: '♯2',
        justIntnation: true
    }
  );
  // パート別に play,pause,stopの各ボタン、seekBar,timeDisplay を作成
  const audioControls = setAudioControls(".audio-container");

  // audioControlインスタンスに、svgPiano,midiファイル,mp3ファイル等を設定
  audioControls.forEach(audioControl => {
    const nameWithTempo = add_temp_to_name(audioControl.options.name);
    audioControl.update({
      svgPiano: svgPiano,
      mp3File: mp3Files[nameWithTempo],
      midiFile: midiFiles[nameWithTempo.replace('vcl_', '')][0],
      trackIndex: midiFiles[nameWithTempo.replace('vcl_', '')][1],
    });
  });

  document.querySelectorAll(".playBtn").forEach(btn => {
    btn.addEventListener("click", function() {
      const commonName = btn.parentNode.getAttribute("name");
      const nameWithTempo = add_temp_to_name(commonName);
      const segment = btn.getAttribute("name");
      const range = ranges(nameWithTempo,segment);
      const [start,end] = range.split(",");      
      console.log(`start,end => ${start},${end}`);
      
      const audioControl = audioControls.find(control => control.options.name === commonName );
      audioControl.update({ segment: range })
      
      if (Number(start) < audioControl.seekBar.value) {
        console.log(`audioControl.seekBar.value => ${audioControl.seekBar.value}`);
        audioControl.playSegment(audioControl.seekBar.value,Number(end));
      } else {
        console.log("audioControl.playSegment()")
        audioControl.playSegment();
      }
    });
  });

  function change_tempo(commonName) {
    const current_tempo = document.getElementById(commonName+'_tempo').innerHTML.replace('=','');
    const new_tempo = current_tempo === '120' ? '98' : '120';
    document.getElementById(commonName+'_tempo').innerHTML = '='+new_tempo;
    const nameWithTempo = add_temp_to_name(commonName);
    
    const mp3File = mp3Files[nameWithTempo];
    const midiFile = midiFiles[nameWithTempo.replace('vcl_', '')][0];
    const trackIndex = midiFiles[nameWithTempo.replace('vcl_', '')][1];
    
    const audioControl = audioControls.find(control => control.options.name === commonName );
    if (audioControl) {
      updateAudioControl(audioControl, mp3File, midiFile, trackIndex)
    }
    function updateAudioControl(audioControl, mp3File, midiFile, trackIndex) {
      if (audioControl.isPlaying) {
        audioControl.stop();
        setTimeout(() => {
          updateAudioControl(audioControl, mp3File, midiFile, trackIndex);
        }, 100);
        return;
      }     
      if (audioControl.options.mp3File !== mp3File) {
        console.log(`update mp3File => ${mp3File}`);
        audioControl.update({
          mp3File: mp3File,
          midiFile: midiFile,
          trackIndex: trackIndex
        });
      }
    }
  }  
  
  function add_temp_to_name(name) {
    console.log(`@add_temp_to_name, name => ${name}`);
    if (name.includes('vcl_')) {
        const tempo = document.getElementById(name+'_tempo').innerHTML.replace('=','');
        console.log(`@add_temp_to_name, tempo => ${tempo}`);
        addedName = `temp${tempo}_${name}`;
    } else {
      addedName = name;
    }
    console.log(`@add_temp_to_name, addedName => ${addedName}`);
    return addedName;
  }
</script>

  </body>
</html>